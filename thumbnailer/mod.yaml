# Copyright 2018 Google LLC
#
# Use of this source code is governed by an MIT-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/MIT.

# required
specVersion: v1beta1
name: thumbnailer
version: 1.0.0 # version of mod


# recommended
description: Automatically generate thumbnails for images uploaded to Firebase Storage.

# required
apis: # APIs that will be auto-enabled during installation
# Cloud Storage
- storage-component.googleapis.com

# IAM roles that the mod will operate under.
# Firebase predefined roles (https://firebase.google.com/docs/projects/iam/roles#firebase_predefined_roles)
# and Cloud predefined roles (https://cloud.google.com/iam/docs/understanding-roles#predefined_roles)
# are supported.
roles:
- firebase.developAdmin # Allows access to write to Realtime Database, no finer grained role that I could find.
- iam.serviceAccountTokenCreator # Signs a blob using a service account's system-managed private key.
- storage.admin # Full control of buckets and objects. When applied to an individual bucket,
#control applies only to the specified bucket and objects within that bucket.

# recommended
env: # env variables that mod consumer sets during install
- var: THUMB_MAX_HEIGHT
  label: Maximum height of thumbnail
  description: >
    What should be the maximum height of the thumbnail (in pixels)?
  # numbers not allowed, need to supply string
  default: "200"
- var: THUMB_MAX_WIDTH
  label: Maximum width of thumbnail
  description: >
    What should be the maximum width of the thumbnail (in pixels)?
  default: "200"
- var: THUMB_PREFIX
  label: Prefix affixed to thumbnail name
  description: >
    How would you like to prefix the thumbnails to distinguish them?
  default: thumb
- var: THUMB_BUCKET
  label: Storage bucket to listen to for creation of thumbnails
  description: >
    What storage bucket will the photos that are to be thumbnailed be uploaded to?
  default: ${STORAGE_BUCKET}
- var: SIGNED_URLS_FOLDER
  label: RTDB node where signed urls for the thumbnail and original image will be uploaded
  description: >
    What would you like to name the node in Firebase Realtime Database 
    under which signed urls (https://cloud.google.com/storage/docs/access-control/signed-urls) 
    for the thumbnail and original image will be uploaded?
  default: images

# required
resources: # Resources created by the mod, will be deleted when user uninstalls mod
- name: generateThumbnail
  type: firebasemods.v1beta1.function
  properties:
    eventTrigger:
      eventType: google.storage.object.finalize
      # PROJECT_ID is autopopulated, COLLECTION is defined in "env" section above
      resource: projects/_/buckets/${THUMB_BUCKET}
