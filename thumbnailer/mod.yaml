# Copyright 2018 Google LLC
#
# Use of this source code is governed by an MIT-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/MIT.

specVersion: v1beta1
name: thumbnailer
version: 1.0.0

description: Automatically generate thumbnails for images uploaded to Firebase Storage.

apis:
# Cloud Storage
- storage-component.googleapis.com

roles:
- firebase.developAdmin
- iam.serviceAccountTokenCreator 
- storage.admin

env:
- var: THUMB_MAX_HEIGHT
  label: Maximum height of thumbnail
  description: >
    What should be the maximum height of the thumbnail (in pixels)?
  # all default values must be strings, so number have to be wrapped in quotes
  default: "200"
- var: THUMB_MAX_WIDTH
  label: Maximum width of thumbnail
  description: >
    What should be the maximum width of the thumbnail (in pixels)?
  default: "200"
- var: THUMB_PREFIX
  label: Prefix affixed to thumbnail name
  description: >
    How would you like to prefix the thumbnails to distinguish them?
  default: thumb
- var: THUMB_BUCKET
  label: Storage bucket to listen to for creation of thumbnails
  description: >
    What storage bucket will the photos that are to be thumbnailed be uploaded to?
  default: ${STORAGE_BUCKET}
- var: SIGNED_URLS_FOLDER
  label: RTDB node where signed urls for the thumbnail and original image will be uploaded
  description: >
    What would you like to name the node in Firebase Realtime Database 
    under which signed urls (https://cloud.google.com/storage/docs/access-control/signed-urls) 
    for the thumbnail and original image will be uploaded?
  default: images

resources:
- name: generateThumbnail
  type: firebasemods.v1beta1.function
  properties:
    eventTrigger:
      eventType: google.storage.object.finalize
      resource: projects/_/buckets/${THUMB_BUCKET}
