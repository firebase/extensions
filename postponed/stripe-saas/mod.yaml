# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

specVersion: v1beta1
name: stripe-saas
displayName: Manage Stripe subscriptions in your applications
version: 0.0.1

description:
  Manage SaaS subscriptions in your application using Stripe as a payment
  processor.

license: Apache-2.0
billingRequired: true

roles:
  - role: datastore.user
    reason: allows the mod to read from and write to Cloud Firestore.

params:
  - param: STRIPE_SECRET_KEY
    type: string
    label: Stripe Secret Key
    description: >
      The secret API key for your Stripe account. Can be found at
      https://dashboard.stripe.com/account/apikeys
    required: true
  - param: STRIPE_SIGNING_SECRET
    type: string
    label: Stripe Signing Secret
    description: >
      Create a new webhook at https://dashboard.stripe.com/account/webhooks. Set
      the "URL to be called" to http://example.com/ (you will change this
      later). Next, click on the webhook you just created and reveal the
      "Signing Secret". This allows the stripe-saas mod to verify incoming
      webhooks as authentic. Enter the secret here.
    required: false
  - param: USERS_COLLECTION
    type: string
    label: Firestore Users Collection
    description: >
      The Firestore users collection in which subscription information will be
      embedded. This collection MUST be keyed by uid and MAY be your primary
      users collection. Only the information in the defined subscription field
      will be written/overwritten by the stripe-saas mod.
    default: users
    required: true
  - param: BILLING_FIELD
    type: string
    label: Firestore Billing Field
    description: >
      Name the document field in the users collection where you want to store
      information about the Stripe customer and subscription. Enter "." to store
      information at the top level of the document.
    default: billing
    required: true
  - param: SUBSCRIPTIONS_COLLECTION
    type: string
    label: Firestore Subscriptions Collection
    description: >
      Name a collection in which to store full Stripe API subscription data.
      This collection must be kept to ensure that duplicate event processing
      does not take place.
    default: _subscriptions
    required: true

resources:
  - name: hook
    type: firebasemods.v1beta1.function
    properties:
      httpsTrigger: {}
      runtime: nodejs8
  - name: subscribe
    type: firebasemods.v1beta1.function
    properties:
      httpsTrigger: {}
      runtime: nodejs8
  - name: unsubscribe
    type: firebasemods.v1beta1.function
    properties:
      httpsTrigger: {}
      runtime: nodejs8
