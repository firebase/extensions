Use this extension to track user presence in a Cloud Firestore collection.

## Introduction
Whenever a user is logged in using `SessionManager` provided by the SDK, the user's presence information is written to RTDB. The resulting RTDB document is mirrored to a Firestore collection using Cloud Functions for Firebase. Each authenticated user will have a document within the Firestore collection (keyed by their Firebase Authentication uuid) that contains two fields relevant to their active connections. The `sessions` field is a map of all active user connections (keyed by `sessionID`, see "User Connections" below). If metadata is set using the SDK, they can be found under `sessions/sessionID` (See "Custom Metadata"). The `last_updated` field contains timestamps of when a `sessionID` was last updated in RTDB.
 
 When a user disconnects, RTDB's `OnDisconnect` function fires and the relevant connection (`sessionID`) and its metadata are removed from RTDB and Firestore. A user is considered offline if the `sessions` map is empty in Firestore.
 
 ## Example
 
 Below is an example of a Firestore document that is associated with some user. The user currently has two active connections where `session1` was supplied with custom metadata.

```
{ 
  sessions: {
    session0: true,
    session1: { custom: metadata }
  },
  last_updated: {
    session0: 10,
    session1: 100
  }
}
```
If the user disconnects from `session1`, the respective field under `sessions` will be removed with its metadata. Although the session is removed, `last_updated` still persists the last updated timestamp (see "Cleanup").
```
{ 
  sessions: {
    session0: true
  },
  last_updated: {
    session0: 10,
    session1: 104
  }
}
```

## Custom Metadata
Custom metadata can be set using the `setMetatdata` function from the SDK. The metadata can be any JSON object with a few exceptions (see warning below). Setting metadata will store the information within the `sessions/{sessionID}` of the user's Firestore document. It's important to note that this `sessionID` may change due to unintentional disconnects/reconnects (see "User Connections"). 

> Warning: custom metadata can not contain nested arrays which are not valid fields in Firestore.

## User Connections
The extension is capable of tracking multiple connections (each with a unique `sessionID` auto-generated by the SDK) for individual users. Thus it is possible to store different metadata per connection and count the number of active connections per user. However, it is **not recommended** to utilize the `sessionID` for business logic because they are **transient**. Any unintentional disconnects/reconnects will remove the previous connection and assign the user a new `sessionID` on reconnect. Custom metadata will persist to the new connection by the client SDK, but a new `sessionID` will be assigned.

## Cleanup
The `last_updated` field in Firestore maintains the timestamp of the most recent transaction from the client for a given `sessionID`. For consistency, they are persisted even after the session is no longer connected.

If you wish to clean them up, the extension provides a cleanup function that is triggered by publishing to a PubSub topic. The function will cleanup all tombstones that have been offline for more than one week. The function/topic can be paired with Cloud Scheduler for periodic cleanups. In most use-cases, these timestamps (or tombstones) will leave a negligible footprint and so usage of this function is not required.

## Parameters
You will need to specify the target collection in Firestore where the presence information will be stored, the document path in RTDB, and name of the PubSub topic for cleanup. All parameters have default values.

When you use Firebase Extensions, you're only charged for the underlying resources that you use. Firebase Extensions themselves are free to use. All Firebase services offer a free tier of usage. [Learn more about Firebase billing.](https://firebase.google.com/pricing)