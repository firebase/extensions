# Copyright 2019 Google LLC
#
# Use of this source code is governed by an MIT-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/MIT.

name: invites-mod
displayName: An invitation service
specVersion: v1beta1
version: 0.1.0
description: >
  Adds basic invite-a-friend functionality to your Android, iOS, or Web app!
  Requires a Sendgrid account, which you can sign up for free.

license: MIT
billingRequired: true
sourceUrl: https://dev-partners.googlesource.com/samples/firebase/mods/+/master/user-referral/
releaseNotesUrl: https://dev-partners.googlesource.com/samples/firebase/mods/+log

author:
  authorName: Firebase
  url: https://firebase.google.com
contributors:
  - authorName: Tina Liang
    url: https://github.com/tinaliang
  - authorName: Chris Bianca
    email: chris@csfrequency.com
    url: https://github.com/chrisbianca

roles:
  - role: datastore.user
    reason:
      allows the mod to store metadata about invitations in Cloud Firestore

resources:
  - name: sendInvitation
    type: firebasemods.v1beta1.function
    description:
      creates an invitation in Cloud Firestore and sends it using the SendGrid
      API
    properties:
      sourceDirectory: .
      location: ${LOCATION}
      httpsTrigger: {}

  - name: acceptInvitation
    type: firebasemods.v1beta1.function
    description:
      marks an invitation as accepted and updates Cloud Firestore accordingly
    properties:
      sourceDirectory: .
      location: ${LOCATION}
      httpsTrigger: {}

params:
  - param: LOCATION
    type: select
    label: Deployment Location
    description: >-
      Where should the mod be deployed? Pick a location that is close to your
      Firestore database. See
      https://firebase.google.com/docs/functions/locations#selecting_regions_for_firestore_and_storage.
    options:
      - label: Iowa (us-central1)
        value: us-central1
      - label: South Carolina (us-east1)
        value: us-east1
      - label: Northern Virginia (us-east4)
        value: us-east4
      - label: Belgium (europe-west1)
        value: europe-west1
      - label: London (europe-west2)
        value: europe-west2
      - label: Hong Kong (asia-east2)
        value: asia-east2
      - label: Tokyo (asia-northeast1)
        value: asia-northeast1

  - param: SENDGRID_API_KEY
    type: string
    label: SendGrid API Key
    description: >
      Your API key for SendGrid. Once you have created a SendGrid account, you
      can  create an API key by going to "API Keys" under "Settings" and
      clicking "Create  API Key". Alternatively, you can go to "Setup Guide" and
      follow the instructions  under "Integrate using our Web API or SMTP
      relay".
    required: true

  - param: SENDGRID_EMAIL_ALIAS
    type: string
    label: SendGrid Email Alias
    description: >
      The email address invitations will be sent from. We do not support sending
      from the inviter's personal email address. This can be your domain's email
      address. You could also create a new email address for the purpose of
      sending invitations.
    required: true
    validationRegex: '^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$'
    validationErrorMessage: >
      You must provide a valid email address.

  - param: APP_NAME
    type: string
    label: The name of the app. This will be used in the invite email.
    required: true

  - param: ACCEPT_URL_TEMPLATE
    type: string
    label: Accept Invitation URL
    description: >
      The URL to include in invitation emails. "{token}" will be replaced with
      the actual invitation token. This token will be generated by the mod when
      the function to send an invitation email is triggered. The default URL
      assumes your app is deployed with Firebase hosting, and uses
      `acceptInvitation` as a query parameter at the root URL. After installing
      the mod, you will be shown usage instructions for how to implement this
      logic.
    default: "https://${PROJECT_ID}.firebaseapp.com/?acceptInvitation={token}"
    validationRegex: '.*\{token\}.*'
    validationErrorMessage: >
      Your URL must include '{token}' so that it can be replaced with an actual
      invitation token.

  - param: TARGET_RECEIVER_FIELDS
    type: string
    label: Document and Field Path for Accepting User's UID
    description: >
      When an invitation is accepted, the mod will add the receiving/accepting
      user's UID to the given document/array field. If the receiver UID is 123
      and sender UID is 234, entering "users/{sender}.friends" here will append
      "123" to the "friends" array field for document "234" in the "users"
      collection. Separate document/field pairs for this var with commas.
    default: users/{sender}.friends
    required: false
    validationRegex: '.+/.+\..+'
    validationErrorMessage: >
      Values must be comma-separated document path + field, e.g.
      coll/doc.field,coll/doc.field

  - param: TARGET_SENDER_FIELDS
    type: string
    label: Document and Field Path for Sending User's UID
    description: >
      When an invitation is accepted, the mod will add the sending user's UID to
      the given document/array field. If the receiver UID is 123 and sender UID
      is 234, entering "users/{receiver}.friends" here will append "234" to the
      "friends" array field for document "123" in the "users" collection.
      Separate document/field pairs for this var with commas.
    default: users/{receiver}.friends
    required: false
    validationRegex: '.+/.+\..+'
    validationErrorMessage: >
      Values must be comma-separated document path + field, e.g.
      coll/doc.field,coll/doc.field

  - param: METADATA_FIRESTORE_COLLECTION
    type: string
    label: Metadata Firestore Collection
    description: >
      A top-level Firestore collection the mod can use to store metadata for
      invitations.
    default: _invitations
    required: true
    validationRegex: '[\w_.-]+'
    validationErrorMessage: >
      Must be a simple alphanumeric field name, optionally with periods,
      underscores, or dashes.
