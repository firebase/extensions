# Copyright 2018 Google LLC
#
# Use of this source code is governed by an MIT-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/MIT.

specVersion: v1beta1
name: limit-children
version: 1.0.0

description: >-
  Keep the number of child nodes in a Firebase database below a given number.
  This can be used to limit the number of lines of a chat history or logs.

roles:
  - firebase.developAdmin

resources:
  - name: truncate
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        eventType: providers/google.firebase.database/eventTypes/ref.write
        resource: projects/_/instances/${DATABASE_INSTANCE}/refs/chat/{messageid}
env:
  - var: MAX_COUNT
    label: Max number of items to keep in the database
    description: >-
      Maximum number of items to keep in the database. Older items will be
      truncated.
    validationRegex: ^\d+$
    validationErrorMessage: Invalid MAX_COUNT, must be a positive integer.
    required: true
  - var: PARENT_NODE_PATH
    label: Path at which this function should limit children.
    description: >-
      Path at which to limit the children. For example, `/chat/{messageid}`, we
      would limit the items under /chat/ to MAX_COUNT.
    validationRegex: ^\S+$
    validationErrorMessage: Path cannot have spaces.
    required: true
