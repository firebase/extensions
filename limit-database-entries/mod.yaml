# Copyright 2019 Google LLC
#
# Use of this source code is governed by an MIT-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/MIT.

specVersion: v1beta1
name: limit-database-entries
version: 1.0.0

description: >-
  Keep the number of items  in a Firebase realtime database for a given path
  below a given number. This can be used to limit the number of lines of a chat
  history or logs.

license: MIT

roles:
  - role: firebasedatabase.admin
    reason: allows the mod to prune extra items from the Realtime Database.

resources:
  - name: truncate
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        eventType: providers/google.firebase.database/eventTypes/ref.create
        resource: projects/_/instances/${DATABASE_INSTANCE}/refs/${NODE_PATH}/{messageid}
params:
  - param: MAX_COUNT
    type: string
    label: Max number of items to keep in the database path
    description: >-
      Maximum number of items to keep in the database path. Older items will be
      truncated.
    validationRegex: ^\d+$
    validationErrorMessage: Invalid MAX_COUNT, must be a positive integer.
    required: true
  - param: NODE_PATH
    type: string
    label: Path at which this function should limit children
    description: >-
      Path at which to limit the number of child nodes.
    validationRegex: ^\S+$
    validationErrorMessage: Path cannot have spaces.
    required: true
