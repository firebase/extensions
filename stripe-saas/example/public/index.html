<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.2.1/litera/bootstrap.min.css">
    <style>
      .container {
        max-width: 600px;
        margin: 0 auto;
      }

      #card-element {
        margin: 24px 0;
      }
    </style>
    <title>stripe-saas example</title>
  </head>
  <body>
    <div class="container">
      <h1>stripe-saas demo</h1>
      <div id="signed-out">
        <h2>You must sign in to subscribe.</h2>
        <button id="sign-in">Sign In with Google</button>
      </div>
      <div id="signed-in" hidden>
        <form id="card-form" class="form-group">
          <div id="card-element"></div>
          <button type="submit" class="btn btn-primary">Subscribe</button>
          <button id="unsubscribe" type="button" class="btn btn-danger">Unsubscribe</button>
        </form>
        <h3>Subscription Info</h3>
        <pre id="data"></pre>
      </div>
    </div>

    <!-- update the version number as needed -->
    <script src="/__/firebase/5.8.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script src="/__/firebase/5.8.1/firebase-auth.js"></script>
    <script src="/__/firebase/5.8.1/firebase-firestore.js"></script>
    <script src="/__/firebase/5.8.1/firebase-functions.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script src="/__/firebase/init.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
      // Stripe publishable key
      const STRIPE_KEY = 'pk_test_IGqARJOiD6NEitxSFCgrQmit';
      // Mod instance ID for callable functions
      const MOD_ID = 'mod-stripe-saas-8dc7';

      const stripe = Stripe(STRIPE_KEY);
      const elements = stripe.elements();

      const card = elements.create('card');
      card.mount('#card-element');

      const auth = firebase.auth();
      const db = firebase.firestore();
      const GOOGLE_AUTH = new firebase.auth.GoogleAuthProvider();

      const subscribe = firebase.functions().httpsCallable(`${MOD_ID}-subscribe`);
      const unsubscribe = firebase.functions().httpsCallable(`${MOD_ID}-unsubscribe`);

      function $(q) { return document.querySelector(q); }
      $('#sign-in').addEventListener('click', async e => {
        e.preventDefault();

        await auth.signInWithPopup(GOOGLE_AUTH);
      });

      let unlisten;
      auth.onAuthStateChanged(user => {
        if (user) {
          $('#signed-in').removeAttribute('hidden');
          $('#signed-out').setAttribute('hidden', true);
          unlisten = db.collection('users').doc(user.uid).onSnapshot(snap => {
            $('#data').innerText = JSON.stringify(snap.data(), null, 2);
          });
        } else {
          $('#signed-out').removeAttribute('hidden');
          $('#signed-in').setAttribute('hidden', true);
          if (unlisten) {
            unlisten();
            unlisten = null;
          }
        }
      });

      $('#card-form').addEventListener('submit', async e => {
        e.preventDefault();
        const tokenResponse = await stripe.createToken(card);
        const result = await subscribe({plan: 'basic', token: tokenResponse.token.id});
        console.log(result);
      });

      $('#unsubscribe').addEventListener('click', async e => {
        e.preventDefault();
        const result = await unsubscribe();
        console.log(result);
      });
    </script>
  </body>
</html>
