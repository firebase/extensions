# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

specVersion: v1beta1
name: budget-notification
displayName: Send budget notifications to Zapier
version: 0.1.0

description:
  Send notifications to Zapier when your Firebase project exceeds your budget. Optionally, you can also configure your Zapier
  account to notify you and your team about budget overshooting via preferrred channels. (Requires a Zapier account)

license: Apache-2.0
billingRequired: true
sourceUrl: https://dev-partners.googlesource.com/samples/firebase/mods/+/master/budget-notifications/
releaseNotesUrl: https://dev-partners.googlesource.com/samples/firebase/mods/+log

author:
  authorName: Firebase
  url: https://firebase.google.com
contributors:
  - authorName: Andriana Romero
    url: https://github.com/andrianabeltran
  - authorName: Chris Bianca
    email: chris@csfrequency.com
    url: https://github.com/chrisbianca


apis:
  - apiName: cloudbilling.googleapis.com
    reason: Todo
  - apiName: pubsub.googleapis.com
    reason: Todo

roles:
  - role: firebase.developAdmin
    reason: Todo

params:
  - param: ZAPIER_WEBHOOK
    type: string
    label: Zapier Webhook URL
    description: i.e. `https://hooks.zapier.com/hooks/catch/XXXXXXX/YYYYYY/`
    validationRegex: ^(?:https?:\/\/hooks.zapier.com/hooks/catch)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$
    validationErrorMessage:
      Zapier url incorrect. e.g.
      (`https://hooks.zapier.com/hooks/catch/XXXXXXX/YYYYYY/`)
    required: true
  - param: TOPIC_NAME
    type: string
    label: Topic Name
    description: >
      The Pub/Sub topic you used to enable budget notifications. Please refer to
      the [Manage
      notifications](`https://cloud.google.com/billing/docs/how-to/budgets#manage-notifications`)
      section to configure a Pub/Sub topic if you haven't already.
    required: true
  - param: EMAIL
    type: string
    label: Email
    description: >
      Email to send notifications to. This is only required if you plan to send
      an email in Zapier.
    validationRegex: ^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$
    validationErrorMessage: Please enter a valid email address.
    required: false

resources:
  - name: sendBudgetNotifications
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        eventType: google.pubsub.topic.publish
        resource: projects/${PROJECT_ID}/topics/${TOPIC_NAME}
