

# Copyright 2018 Google LLC
#
# Use of this source code is governed by an MIT-style
# license that can be found in the LICENSE file or at
# https://opensource.org/licenses/MIT.

specVersion: v1beta1
name: budget-notification
version: 1.0.0

description:
  A mod that sends budget alerts to Zapier and allows the mod consumer to
  configure notifications based on budget thresholds and optionally set a hard
  cap to disable billing.

apis:
  - cloudbilling.googleapis.com
  - pubsub.googleapis.com

roles:
  - firebase.developAdmin

env:
  - var: ZAPIER_WEBHOOK
    label: Zapier Webhook URL
    description: i.e. `https://hooks.zapier.com/hooks/catch/4732777/njgeg1/`
    validationRegex: ^(?:https?:\/\/hooks.zapier.com/hooks/catch)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$
    validationErrorMessage: Zapier url incorrect. e.g. (`https://hooks.zapier.com/hooks/catch/4732777/njgeg1/`)
    required: true
  - var: TOPIC_NAME
    label: Topic Name
    description: >
      The Pub/Sub topic you used to enable budget notifications. Please refer
      to the [Manage notifications](`https://cloud.google.com/billing/docs/how-to/budgets#manage-notifications`)
      section to configure a Pub/Sub topic if you haven't already.
    required: true
  - var: EMAIL
    label: Email
    description: >
      Email to send notifications to. This is only required if you plan to
      send an email in Zapier.
    validationRegex: ^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$
    validationErrorMessage: Please enter a valid email address.
    required: false

resources:
  - name: sendBudgetNotifications
    type: firebasemods.v1beta1.function
    properties:
      runtime: nodejs8
      eventTrigger:
        eventType: google.pubsub.topic.publish
        resource: projects/${PROJECT_ID}/topics/${TOPIC_NAME}


